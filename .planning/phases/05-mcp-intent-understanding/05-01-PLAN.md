# Phase 5 Plan 1: MCP Intent Understanding

**Phase:** 05-mcp-intent-understanding
**Plan:** 01
**Created:** 2026-01-15
**Status:** Ready for execution

## Objective

Enhance cancer-mcp to communicate application **intent** and **purpose**, not just structure. Enable agents to understand "why" an app is built the way it is, not just "what" endpoints exist.

## Context

Current cancer-mcp provides excellent structural introspection (34 tools, routes, models, services) but lacks semantic context. Agents see `GET /rifugio/{id}` but don't understand it's "fetch shelter details for visitors" with specific requirements.

The MCP specification provides the primitives: tool annotations, rich descriptions, resources for persistent context, and prompts for guided workflows. The work is applying these systematically.

## Dependencies

- **Requires:** Phase 4 complete (convention-over-configuration patterns)
- **Research:** 05-RESEARCH.md (completed 2026-01-15)

## Task Breakdown

### Task 1: Enhance Tool Descriptions with Structured Intent

**Goal:** Transform minimal tool descriptions into structured semantic context with when/why/how patterns.

**Files to modify:**
- `cancer-mcp/src/service.rs` - All 34 tool descriptions

**Changes:**
1. Update each tool's description to include:
   - **When to use:** Scenarios where this tool is appropriate
   - **Returns:** What the output contains
   - **Combine with:** Related tools for workflows
2. Add tool annotations where applicable:
   - `readOnlyHint: true` for read-only tools
   - `idempotentHint: true` for repeatable operations
   - `destructiveHint: true` for state-changing operations

**Pattern:**
```rust
// BEFORE (minimal):
#[tool(name = "list_routes", description = "List all routes defined in the application")]

// AFTER (rich intent):
#[tool(
    name = "list_routes",
    description = "List all HTTP routes defined in the application.\n\n\
        **When to use:** Understanding API surface, finding endpoints to test or modify, \
        verifying route registration after changes.\n\n\
        **Returns:** Method, path, handler function, middleware chain.\n\n\
        **Combine with:** `get_handler` to see implementation, `test_route` to exercise."
)]
```

**Verification:**
- `cargo check --package cancer-mcp` passes
- `cargo test --package cancer-mcp` passes
- Tool descriptions visible in MCP client introspection

**Estimated scope:** 34 tools × ~5 lines description = ~170 lines modified

---

### Task 2: Add Domain Glossary Resource

**Goal:** Expose business domain terms as an MCP resource that agents can query to understand what models and routes represent.

**Files to create:**
- `cancer-mcp/src/resources/mod.rs` - Resource module
- `cancer-mcp/src/resources/glossary.rs` - Domain glossary implementation

**Files to modify:**
- `cancer-mcp/src/lib.rs` - Export resources module
- `cancer-mcp/src/service.rs` - Register glossary resource

**Changes:**
1. Create MCP resource with URI `cancer://domain/glossary`
2. Extract domain terms from models and routes
3. Generate glossary entries with:
   - `definition`: What the term means
   - `models`: Related model names
   - `routes`: Related route paths
   - `intent`: Business context

**Pattern:**
```rust
#[resource(
    uri = "cancer://domain/glossary",
    name = "Domain Glossary",
    description = "Business domain terms and their definitions. Query to understand models and routes.",
    mime_type = "application/json"
)]
pub async fn domain_glossary(&self) -> String {
    // Extract from models, generate definitions
}
```

**Verification:**
- `cargo check --package cancer-mcp` passes
- Resource accessible via MCP resource list
- Glossary contains entries for sample app models (User, Todo, Rifugio)

---

### Task 3: Implement explain_route Tool

**Goal:** Tool that explains the purpose and business context of a specific route.

**Files to create:**
- `cancer-mcp/src/tools/explain_route.rs` - Route explanation logic

**Files to modify:**
- `cancer-mcp/src/tools/mod.rs` - Export explain_route
- `cancer-mcp/src/service.rs` - Add explain_route tool method

**Changes:**
1. Create explain_route tool that:
   - Takes route path as parameter
   - Returns purpose, business context, guards, related routes
   - Extracts intent from handler doc comments if available
   - Infers from patterns (guarded = auth required, etc.)

**Output format:**
```json
{
    "route": "/users/{id}",
    "purpose": "Display user profile for authenticated viewing",
    "business_context": "Core entity for user management",
    "guards": ["AuthMiddleware"],
    "related_routes": ["/users", "/users/{id}/edit"],
    "usage_examples": ["GET /users/123"]
}
```

**Verification:**
- `cargo check --package cancer-mcp` passes
- `cargo test --package cancer-mcp` passes
- Tool returns meaningful explanation for sample app routes

---

### Task 4: Implement explain_model Tool

**Goal:** Tool that explains what a model represents in the business domain.

**Files to create:**
- `cancer-mcp/src/tools/explain_model.rs` - Model explanation logic

**Files to modify:**
- `cancer-mcp/src/tools/mod.rs` - Export explain_model
- `cancer-mcp/src/service.rs` - Add explain_model tool method

**Changes:**
1. Create explain_model tool that:
   - Takes model name as parameter
   - Returns domain meaning, relationships, common queries
   - Extracts from doc comments and field names
   - Links to related routes and services

**Output format:**
```json
{
    "model": "User",
    "domain_meaning": "Application user account with authentication credentials",
    "fields": {
        "id": "Unique identifier",
        "email": "Login credential and contact method",
        "name": "Display name for UI"
    },
    "relationships": ["has_many: todos"],
    "related_routes": ["/users", "/users/{id}"],
    "common_queries": ["find_by_email", "find_by_id"]
}
```

**Verification:**
- `cargo check --package cancer-mcp` passes
- `cargo test --package cancer-mcp` passes
- Tool returns meaningful explanation for sample app models

---

### Task 5: Enhance Server Instructions with Workflow Guidance

**Goal:** Update CANCER_MCP_INSTRUCTIONS to include tool workflow documentation.

**Files to modify:**
- `cancer-mcp/src/service.rs` - CANCER_MCP_INSTRUCTIONS constant

**Changes:**
1. Add "Tool Workflows" section with common patterns:
   - Understanding a Feature workflow
   - Debugging an Issue workflow
   - Adding a Feature workflow
2. Add "See also" references between related tools
3. Document the new explain tools and glossary resource

**Pattern:**
```rust
const CANCER_MCP_INSTRUCTIONS: &str = r#"
# Cancer Framework MCP Server

## Tool Workflows

### Understanding a Feature
1. `list_routes` - Find relevant endpoints
2. `explain_route` for each - Understand purpose
3. `list_models` - See data structures
4. `explain_model` - Understand domain meaning
5. `relation_map` - See how models connect

### Debugging an Issue
1. `last_error` - Get recent error
2. `get_handler` - Read the failing code
3. `read_logs` - Context around error time
4. `explain_route` - Understand expected behavior
...
"#;
```

**Verification:**
- `cargo check --package cancer-mcp` passes
- Instructions appear in MCP server info response

---

## Dependency Graph

```
Task 1 (Descriptions) ─────┐
                           ├──> Task 5 (Instructions)
Task 2 (Glossary) ─────────┤
                           │
Task 3 (explain_route) ────┤
                           │
Task 4 (explain_model) ────┘
```

- Tasks 1-4 are independent and can run in parallel
- Task 5 depends on all others (references new tools in instructions)

## Wave Assignments

| Wave | Tasks | Rationale |
|------|-------|-----------|
| 1 | 1, 2, 3, 4 | Independent tasks, parallelizable |
| 2 | 5 | Depends on all Wave 1 tasks |

## Execution Plan

### Wave 1 (Parallel)

Execute all four tasks concurrently:
- **Task 1:** Enhance all 34 tool descriptions
- **Task 2:** Create domain glossary resource
- **Task 3:** Implement explain_route tool
- **Task 4:** Implement explain_model tool

### Wave 2 (Sequential)

After Wave 1 completes:
- **Task 5:** Enhance server instructions with workflow guidance

## Verification Checklist

After all tasks complete:

1. [ ] `cargo check --package cancer-mcp` passes
2. [ ] `cargo test --package cancer-mcp` passes
3. [ ] `cargo clippy --package cancer-mcp` passes
4. [ ] All 34 tools have rich descriptions
5. [ ] Domain glossary resource accessible
6. [ ] explain_route returns meaningful output
7. [ ] explain_model returns meaningful output
8. [ ] Server instructions document workflows

## Success Criteria

Phase 5 is complete when:
1. Agent can query `domain_glossary` to learn business terms
2. Agent can use `explain_route` to understand endpoint purpose
3. Agent can use `explain_model` to understand data meaning
4. All tools have when/why/how documentation
5. Server instructions guide tool composition

## Notes

- No new dependencies required (rmcp 0.12 already supports all needed features)
- Tool annotations (readOnlyHint, etc.) are advisory - add where meaningful
- Keep intent close to code - extract from doc comments when possible
- Start simple with glossary (term → definition), expand if needed

---

*Phase: 05-mcp-intent-understanding*
*Plan: 01*
*Ready for execution: yes*
