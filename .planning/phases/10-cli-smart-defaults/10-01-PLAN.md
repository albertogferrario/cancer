# Phase 10: CLI Smart Defaults - Plan 1

## Objective

Add context-aware pattern detection to make:scaffold that analyzes the existing codebase and suggests smart defaults. The CLI should detect project conventions and auto-configure scaffold options.

## Scope

**In scope:**
- Project structure analyzer to detect conventions
- Auto-detect API-only vs Inertia projects
- Auto-suggest --with-tests based on test directory patterns
- Auto-suggest --with-factory based on factories directory
- Field name inference (e.g., `user_id` → reference type)
- Smart defaults summary output before generation

**Out of scope:**
- Detecting complex relationships (deferred to Phase 11)
- Machine learning for pattern detection
- Cross-project pattern learning

## Tasks

### Task 1: Create project analyzer module

Create a reusable analyzer that scans project structure for conventions.

**File:** `cancer-cli/src/analyzer.rs`

**Implementation:**
```rust
pub struct ProjectAnalyzer {
    root: PathBuf,
}

pub struct ProjectConventions {
    pub has_tests_dir: bool,
    pub has_factories_dir: bool,
    pub has_inertia_pages: bool,
    pub existing_models: Vec<String>,
    pub test_pattern: TestPattern, // None, PerController, Unified
    pub factory_pattern: FactoryPattern, // None, PerModel, Unified
}

impl ProjectAnalyzer {
    pub fn new(root: PathBuf) -> Self;
    pub fn analyze(&self) -> ProjectConventions;
}
```

**Acceptance criteria:**
- [ ] ProjectAnalyzer::new() accepts project root path
- [ ] analyze() returns ProjectConventions struct
- [ ] Detects src/tests/ directory presence
- [ ] Detects src/factories/ directory presence
- [ ] Detects frontend/src/pages/ directory for Inertia
- [ ] Lists existing models from src/models/

**Commit:** `feat(cli): add project analyzer for convention detection`

---

### Task 2: Add API-only project detection

Enhance make:scaffold to auto-detect API-only projects and default to --api flag.

**File:** `cancer-cli/src/commands/make_scaffold.rs`

**Implementation:**
- Use ProjectAnalyzer to check for Inertia pages
- If no frontend/src/pages/ exists or is empty, suggest --api
- Print suggestion to user before proceeding
- Add --no-smart-defaults flag to disable detection

**Acceptance criteria:**
- [ ] Detects missing/empty frontend/src/pages/
- [ ] Prints "Detected API-only project, using --api flag" when appropriate
- [ ] --no-smart-defaults flag skips all auto-detection
- [ ] Doesn't override explicit --api or lack thereof when user specifies

**Commit:** `feat(cli): auto-detect API-only projects in make:scaffold`

---

### Task 3: Add test/factory pattern detection

Auto-suggest --with-tests and --with-factory based on existing patterns.

**File:** `cancer-cli/src/commands/make_scaffold.rs`

**Implementation:**
- Check if src/tests/ has *_controller_test.rs files
- Check if src/factories/ has *_factory.rs files
- If patterns detected, suggest corresponding flags
- Print smart defaults summary before generation

**Acceptance criteria:**
- [ ] Detects existing test files matching *_controller_test.rs
- [ ] Detects existing factory files matching *_factory.rs
- [ ] Prints "Detected test pattern, suggesting --with-tests"
- [ ] Prints "Detected factory pattern, suggesting --with-factory"
- [ ] User can override with explicit flags

**Commit:** `feat(cli): auto-detect test and factory patterns`

---

### Task 4: Add field name inference

Infer field types from naming conventions.

**File:** `cancer-cli/src/commands/make_scaffold.rs`

**Implementation:**
- Fields ending in `_id` → suggest bigint (foreign key)
- Fields ending in `_at` → suggest datetime
- Fields named `email` → suggest string with validation hint
- Fields named `password` → suggest string (hashed)
- Fields named `is_*` or `has_*` → suggest bool
- Print inferred types when parsing fields

**Acceptance criteria:**
- [ ] `user_id` parsed without type defaults to bigint
- [ ] `created_at` parsed without type defaults to datetime
- [ ] `email` parsed without type defaults to string
- [ ] `is_active` parsed without type defaults to bool
- [ ] Prints "Inferred {field}: {type}" for each inference
- [ ] Explicit types override inference

**Commit:** `feat(cli): infer field types from naming conventions`

---

### Task 5: Add smart defaults summary

Display a summary of detected conventions and applied defaults before generation.

**File:** `cancer-cli/src/commands/make_scaffold.rs`

**Implementation:**
```
Smart Defaults Detected:
  Project type: API-only (no Inertia pages found)
  Test pattern: Per-controller (5 existing test files)
  Factory pattern: Per-model (3 existing factories)

Applied flags: --api --with-tests --with-factory

Field type inference:
  user_id → bigint (foreign key pattern)
  created_at → datetime (timestamp pattern)

Proceed with generation? [Y/n]
```

**Acceptance criteria:**
- [ ] Summary displays before generation starts
- [ ] Shows detected project type
- [ ] Shows detected patterns with counts
- [ ] Shows applied flags
- [ ] Shows field inferences
- [ ] Interactive confirmation (--yes skips)
- [ ] --quiet flag suppresses summary

**Commit:** `feat(cli): display smart defaults summary before scaffold generation`

## Dependencies

```
Task 1 (analyzer) ─┬─→ Task 2 (API detection)
                   ├─→ Task 3 (test/factory detection)
                   └─→ Task 5 (summary)

Task 4 (field inference) → Task 5 (summary)
```

## Execution Plan

**Wave 1:** Task 1 (analyzer module - foundation)
**Wave 2:** Tasks 2, 3, 4 (parallel - independent features using analyzer)
**Wave 3:** Task 5 (summary - requires all detection features)

## Checkpoints

- **After Task 1:** Verify analyzer correctly detects project structure
- **After Wave 2:** Test each detection feature independently
- **After Task 5:** Full integration test with all smart defaults

## Testing Strategy

Each task includes manual testing of the detection logic:
1. Run make:scaffold on sample app with various structures
2. Verify correct detection of existing patterns
3. Verify proper flag suggestions
4. Verify override behavior with explicit flags

## Files Modified

- `cancer-cli/src/analyzer.rs` (new)
- `cancer-cli/src/commands/make_scaffold.rs`
- `cancer-cli/src/commands/mod.rs` (add analyzer module)
- `cancer-cli/src/main.rs` (add --no-smart-defaults, --quiet flags)

## Estimated Scope

- **Tasks:** 5
- **Files:** 4 (1 new, 3 modified)
- **Complexity:** Medium (pattern detection logic)
- **Risk:** Low (additive feature, no breaking changes)
