# Phase 3, Plan 1: Validate Derive Macro

## Context

Phase 3 of the Cancer Framework DX Overhaul focuses on validation syntax streamlining. The goal is to reduce boilerplate in validation rule definitions while making patterns more agent-friendly.

### Current State

Validation currently uses a builder pattern with a `rules!` macro:

```rust
Validator::new(&data)
    .rules("email", rules![required(), email()])
    .rules("password", rules![required(), min(8)])
    .validate()
```

This approach has friction points:
1. Field names are strings (typo-prone, no compile-time checking)
2. Rules are separate from the data structure they validate
3. CLI scaffolding generates verbose validation blocks
4. Agents must coordinate between struct definitions and validation logic

### Target State

A derive macro that defines validation rules as attributes on struct fields:

```rust
#[derive(Validate)]
struct CreateUserRequest {
    #[validate(required, email)]
    email: String,

    #[validate(required, min(8))]
    password: String,

    #[validate(required, integer, min(18))]
    age: Option<i32>,
}

// Usage
let request: CreateUserRequest = req.input().await?;
request.validate()?;
```

Benefits:
- Validation rules co-located with struct definition
- Compile-time field name checking
- Simpler agent generation (one struct with attributes)
- Consistent with CancerModel derive pattern from Phase 2

### Prior Phase Patterns

Phase 2 established derive macro patterns:
- Parse struct fields with syn
- Generate trait implementations
- Use fully qualified paths to avoid import issues
- Apply to entity structs, keep model files minimal

## Scope

**Duration estimate:** 45-60 minutes (medium complexity)

**Wave structure:**
- Wave 1: Create Validate derive macro infrastructure
- Wave 2: Implement rule attribute parsing and code generation
- Wave 3: Update CLI scaffolding to use new pattern
- Wave 4: Validation and documentation

## Dependencies

- Requires: Phase 2 complete (provides derive macro patterns)
- Provides: Derive-based validation for Phase 4 conventions
- Affects: CLI scaffolding, future form request generation

## Wave 1: Macro Infrastructure

### Task 1.1: Create validate derive macro skeleton

**Files:**
- `cancer-macros/src/validate.rs` (create)
- `cancer-macros/src/lib.rs` (modify)

**Implementation:**
1. Create new file `cancer-macros/src/validate.rs`
2. Add basic derive macro that parses struct fields
3. Register in `lib.rs` with `#[proc_macro_derive(Validate, attributes(validate))]`
4. Generate empty `Validatable` trait implementation

**Verification:**
```bash
cargo check -p cancer-macros
```

**Commit:** `feat(03-01): add Validate derive macro skeleton`

### Task 1.2: Define Validatable trait in framework

**Files:**
- `framework/src/validation/validatable.rs` (create)
- `framework/src/validation/mod.rs` (modify)

**Implementation:**
1. Create `Validatable` trait:
   ```rust
   pub trait Validatable {
       fn validate(&self) -> Result<(), ValidationError>;
       fn validation_rules() -> Vec<(&'static str, Vec<Box<dyn Rule>>)>;
   }
   ```
2. Export from validation module
3. Re-export from framework prelude

**Verification:**
```bash
cargo check -p cancer
```

**Commit:** `feat(03-01): add Validatable trait to validation module`

## Wave 2: Rule Parsing and Generation

### Task 2.1: Parse validate attributes

**Files:**
- `cancer-macros/src/validate.rs` (modify)

**Implementation:**
1. Parse `#[validate(...)]` attributes on fields
2. Support rule formats:
   - Simple: `required`, `email`, `string`
   - With args: `min(8)`, `max(255)`, `between(1, 100)`
   - Conditional: `required_if(other_field, value)`
3. Store parsed rules per field

**Verification:**
```bash
cargo check -p cancer-macros
```

**Commit:** `feat(03-01): parse validate attributes in derive macro`

### Task 2.2: Generate validation code

**Files:**
- `cancer-macros/src/validate.rs` (modify)

**Implementation:**
1. Generate `Validatable` impl for the struct
2. In `validate()`:
   - Serialize struct to serde_json::Value
   - Create Validator with parsed rules
   - Return validation result
3. In `validation_rules()`:
   - Return static rule definitions (for introspection)
4. Use fully qualified paths: `cancer::validation::Rule`, etc.

**Verification:**
```bash
cargo test -p cancer-macros
```

**Commit:** `feat(03-01): generate Validatable implementation in derive macro`

## Wave 3: CLI Integration

### Task 3.1: Update scaffold request template

**Files:**
- `cancer-cli/src/commands/make_scaffold.rs` (modify)

**Implementation:**
1. Update request struct generation to use `#[derive(Validate)]`
2. Add `#[validate(...)]` attributes based on field types:
   - String → `#[validate(required)]`
   - Email field → `#[validate(required, email)]`
   - Integer → `#[validate(required, integer)]`
3. Remove manual Validator builder code from controller templates
4. Generate `request.validate()?` call instead

**Verification:**
```bash
cargo test -p cancer-cli
```

**Commit:** `feat(03-01): update CLI scaffolding to use Validate derive`

### Task 3.2: Add make:request command (stretch goal)

**Files:**
- `cancer-cli/src/commands/make_request.rs` (create)
- `cancer-cli/src/commands/mod.rs` (modify)
- `cancer-cli/src/main.rs` (modify)

**Implementation:**
1. Create dedicated command for generating form request structs
2. Accept field specifications with validation rules
3. Generate struct with Validate derive and appropriate attributes

**Verification:**
```bash
cargo run -p cancer-cli -- make:request --help
```

**Commit:** `feat(03-01): add make:request CLI command`

## Wave 4: Validation

### Task 4.1: Add integration tests

**Files:**
- `framework/tests/validation_derive.rs` (create)

**Implementation:**
1. Test basic validation with derive macro
2. Test all rule types (required, email, min, max, etc.)
3. Test error message generation
4. Test validation_rules() introspection method

**Verification:**
```bash
cargo test -p cancer --test validation_derive
```

**Commit:** `test(03-01): add integration tests for Validate derive macro`

### Task 4.2: Final validation

**Implementation:**
1. Run full test suite
2. Run clippy
3. Verify sample app still compiles

**Verification:**
```bash
cargo test --workspace --exclude cancer-storage
cargo clippy --workspace --exclude cancer-storage
cargo check -p app
```

**Commit:** None (validation only)

## Success Criteria

- [ ] `#[derive(Validate)]` macro compiles and generates code
- [ ] Validation rules parsed from `#[validate(...)]` attributes
- [ ] Generated code validates struct data correctly
- [ ] CLI scaffolding uses new derive pattern
- [ ] All existing tests pass
- [ ] No clippy warnings introduced

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Complex rule syntax (required_if) | Start with simple rules, add complex ones incrementally |
| Macro hygiene issues | Follow Phase 2 pattern: fully qualified paths |
| Breaking existing validation | New system is additive; old Validator still works |

## Checkpoint Strategy

- After Wave 1: Basic macro structure compiles
- After Wave 2: Simple structs can derive Validate and run validation
- After Wave 3: CLI generates new pattern
- After Wave 4: Full test coverage

## Notes

- Task 3.2 (make:request command) is a stretch goal - skip if time constrained
- The existing `Validator` builder pattern remains available for dynamic validation
- Consider future enhancement: validation message customization via attributes
