# Plan 33-01: Inertia DX Quick Wins

<objective>
Improve Inertia developer experience with documentation for SavedInertiaContext and optional JSON Accept header fallback. Quick wins that provide immediate value with minimal effort.
</objective>

<execution_context>
Phase: 33 - Inertia DX Improvements
Milestone: v2.1 JSON-UI
Dependencies: None (standalone improvements)
</execution_context>

<context>
**From backlog (.planning/backlog/inertia-dx-improvements.md):**
- Issue 2: SavedInertiaContext Documentation (Low severity, Low effort)
- Issue 4: JSON Accept Header Handling (Low severity, Low effort)

**Existing state:**
- SavedInertiaContext exists and is documented in docs/src/features/inertia.md
- Documentation covers the basic pattern but could be more prominent
- No JSON fallback currently - only X-Inertia header triggers JSON response

**Key files:**
- `docs/src/features/inertia.md` - Main Inertia documentation
- `ferro-inertia/src/response.rs` - Inertia::render() implementation
- `ferro-inertia/src/lib.rs` - Public exports
</context>

<tasks>

<task id="1">
<title>Enhance SavedInertiaContext Documentation</title>
<type>docs</type>
<description>
Make SavedInertiaContext pattern more prominent in documentation. Add a dedicated section explaining the "request body consumption" problem and solution pattern.
</description>
<files>
- docs/src/features/inertia.md
</files>
<action>
1. Add a "Common Patterns" section after "SavedInertiaContext" section (around line 256)
2. Add a "Troubleshooting" section at the end with common issues
3. Add explicit warning about request body consumption in form handling section
4. Cross-reference SavedInertiaContext in the "Forms" section prominently

Content to add to "Common Patterns":
```markdown
## Common Patterns

### Form Handling with Validation

The most common pattern requiring `SavedInertiaContext` is form validation. Here's the complete flow:

```rust
use ferro::{handler, Request, Response};
use ferro::inertia::{Inertia, SavedInertiaContext};
use ferro::validation::{Validator, rules};

#[handler]
pub async fn store(req: Request) -> Response {
    // STEP 1: Save context BEFORE consuming the request body
    // This is required because req.json()/req.input() consumes the body
    let ctx = SavedInertiaContext::from_request(&req);

    // STEP 2: Now safely consume the request body
    let data: CreateItemRequest = req.json().await?;

    // STEP 3: Validate
    let errors = Validator::new()
        .rule("name", rules![required(), string(), min(1)])
        .rule("email", rules![required(), email()])
        .validate(&data);

    // STEP 4: On validation failure, render with saved context
    if errors.fails() {
        return Inertia::render_ctx(&ctx, "Items/Create", FormProps {
            errors: Some(errors.to_json()),
            old: Some(data),
        });
    }

    // STEP 5: On success, redirect
    let item = Item::create(&data).await?;
    Inertia::redirect_ctx(&ctx, &format!("/items/{}", item.id))
}
```

> **Why SavedInertiaContext?** The request body in Rust can only be read once. Once you call `req.json()` or `req.input()`, the body is consumed. But `Inertia::render()` needs request metadata (headers, URL). `SavedInertiaContext` captures this metadata before body consumption.
```

Add to Troubleshooting:
```markdown
## Troubleshooting

### "Cannot render Inertia response - request already consumed"

**Symptom:** Error when calling `Inertia::render()` after `req.json()` or `req.input()`.

**Cause:** The request body was consumed before rendering.

**Solution:** Use `SavedInertiaContext`:
```rust
let ctx = SavedInertiaContext::from_request(&req);  // Save first
let data = req.json().await?;                        // Then consume
Inertia::render_ctx(&ctx, "Component", props)        // Use saved context
```
```
</action>
<verify>
- Build docs: `cd docs && mdbook build`
- Check sections appear in generated HTML
- Verify all code examples compile (syntax check)
</verify>
<done>Documentation updated with prominent SavedInertiaContext guidance and troubleshooting section</done>
</task>

<task id="2">
<title>Add JSON Accept Header Fallback</title>
<type>feature</type>
<description>
Add optional JSON fallback for `Accept: application/json` requests without X-Inertia header. This allows API clients and testing tools to get raw JSON props.
</description>
<files>
- ferro-inertia/src/response.rs
- ferro-inertia/src/lib.rs
</files>
<action>
1. Add `with_json_fallback()` method to InertiaResponse builder
2. Check Accept header in render path when fallback enabled
3. Return raw JSON props if `Accept: application/json` and no `X-Inertia` header

Implementation in `response.rs`:
```rust
impl InertiaResponse {
    /// Enable JSON fallback for Accept: application/json requests.
    ///
    /// When enabled, requests with `Accept: application/json` header
    /// (but without `X-Inertia: true`) will receive raw JSON props
    /// instead of HTML or Inertia JSON response.
    ///
    /// Useful for API testing and clients that want raw data.
    pub fn with_json_fallback(mut self) -> Self {
        self.json_fallback = true;
        self
    }
}
```

In render logic, add check:
```rust
// Check for JSON fallback before normal Inertia handling
if self.json_fallback
    && !is_inertia_request
    && accepts_json(&request)
{
    return Response::json(&self.props);
}
```

Helper function:
```rust
fn accepts_json(req: &Request) -> bool {
    req.header("Accept")
        .map(|h| h.contains("application/json"))
        .unwrap_or(false)
}
```
</action>
<verify>
```bash
# Run existing tests
cargo test -p ferro-inertia

# Test JSON fallback manually
# 1. Start dev server
# 2. curl -H "Accept: application/json" http://localhost:3000/some-inertia-route
# 3. Should return raw JSON props (if using with_json_fallback())
```
</verify>
<done>JSON fallback feature added and documented</done>
</task>

<task id="3">
<title>Document JSON Fallback Feature</title>
<type>docs</type>
<description>
Add documentation for the new JSON fallback feature in Inertia docs.
</description>
<files>
- docs/src/features/inertia.md
</files>
<action>
Add section after "Development vs Production":

```markdown
## JSON API Fallback

For testing or API clients that need raw JSON data from Inertia routes, enable JSON fallback:

```rust
#[handler]
pub async fn show(req: Request, post: Post) -> Response {
    Inertia::render(&req, "Posts/Show", ShowProps { post })
        .with_json_fallback()  // Enable JSON fallback
}
```

When enabled:
- Requests with `X-Inertia: true` header → Normal Inertia JSON response
- Requests with `Accept: application/json` (no X-Inertia) → Raw props as JSON
- Browser requests → Full HTML page

This is useful for:
- API testing with curl or Postman
- Hybrid apps that sometimes need raw JSON
- Debug tooling

> **Note:** This is opt-in per route. Consider security implications before enabling on sensitive routes.
```
</action>
<verify>
- Build docs: `cd docs && mdbook build`
- Verify section appears correctly
</verify>
<done>JSON fallback feature documented</done>
</task>

<task id="4">
<title>Update ferro-inertia Exports</title>
<type>code</type>
<description>
Ensure all new functionality is properly exported from ferro-inertia.
</description>
<files>
- ferro-inertia/src/lib.rs
</files>
<action>
Verify exports include SavedInertiaContext (already exported) and any new types.
No changes expected - just verification.
</action>
<verify>
```bash
cargo doc -p ferro-inertia --no-deps
# Check SavedInertiaContext appears in docs
```
</verify>
<done>Exports verified</done>
</task>

</tasks>

<verification>
```bash
# Full verification
cd /Users/alberto/repositories/albertogferrario/ferro

# 1. Build framework
cargo build --all

# 2. Run tests
cargo test --all

# 3. Build docs
cd docs && mdbook build && cd ..

# 4. Lint
cargo fmt --check
cargo clippy --all
```
</verification>

<success_criteria>
- [ ] SavedInertiaContext documentation is more prominent with clear pattern explanation
- [ ] Troubleshooting section added to Inertia docs
- [ ] JSON fallback feature implemented with `with_json_fallback()` method
- [ ] JSON fallback documented
- [ ] All tests pass
- [ ] Documentation builds without errors
</success_criteria>

<output>
Files modified:
- docs/src/features/inertia.md (enhanced documentation)
- ferro-inertia/src/response.rs (JSON fallback)
- ferro-inertia/src/lib.rs (exports verification)

Commit: "feat(inertia): add JSON fallback and enhance SavedInertiaContext docs"
</output>
