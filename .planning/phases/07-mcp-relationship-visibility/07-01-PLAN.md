# Phase 7 Plan 1: MCP Relationship Visibility

## Context

**Phase Goal:** Relationship and data flow visibility through MCP
**Dependencies:** Phase 6 (MCP Error Context) - complete
**Scope:** Standard (4 tasks, ~30 min)

### Current State

The cancer-mcp server provides:
- `relation_map` - FK relationships between database tables (db-level)
- `list_routes` - Route definitions with handler paths
- `get_handler` - Handler source with Inertia component info
- `explain_route` / `explain_model` - Semantic understanding

### Gap Analysis

Missing relationship visibility:
1. **Route-to-Model mapping** - Which models does a handler use?
2. **Model-to-Route mapping** - Which routes interact with a model?
3. **Application dependency graph** - Unified view of all relationships

### Approach

Add three new tools:
1. `route_dependencies` - Analyze handler source to detect model usage
2. `model_usages` - Find all routes/handlers that reference a model
3. `dependency_graph` - Generate comprehensive application relationship graph

---

## Tasks

### Task 1: Implement route_dependencies Tool

<task id="1">
<title>Implement route_dependencies tool</title>
<description>
Create a new tool that analyzes a handler's source code to identify which models it uses.
Detects model references through:
- Entity type annotations (e.g., `User::Entity`)
- Model imports and usage patterns
- Database query patterns with model names
</description>
<depends_on></depends_on>
<files>
  <create>cancer-mcp/src/tools/route_dependencies.rs</create>
  <modify>cancer-mcp/src/tools/mod.rs</modify>
  <modify>cancer-mcp/src/service.rs</modify>
</files>
<verification>
  <check>cargo build -p cancer-mcp</check>
  <check>cargo test -p cancer-mcp route_dependencies</check>
  <check>cargo clippy -p cancer-mcp -- -D warnings</check>
</verification>
<acceptance>
- Tool registered in service.rs with structured description
- Returns: models_used (Vec), inertia_component (Option), services_used (Vec)
- At least 2 unit tests verifying model detection from source code
</acceptance>
</task>

### Task 2: Implement model_usages Tool

<task id="2">
<title>Implement model_usages tool</title>
<description>
Create a tool that finds all routes/handlers that reference a given model.
Inverse of route_dependencies - answers "where is this model used?"
Scans all handler files for model references.
</description>
<depends_on>1</depends_on>
<files>
  <create>cancer-mcp/src/tools/model_usages.rs</create>
  <modify>cancer-mcp/src/tools/mod.rs</modify>
  <modify>cancer-mcp/src/service.rs</modify>
</files>
<verification>
  <check>cargo build -p cancer-mcp</check>
  <check>cargo test -p cancer-mcp model_usages</check>
  <check>cargo clippy -p cancer-mcp -- -D warnings</check>
</verification>
<acceptance>
- Tool registered in service.rs with structured description
- Returns: routes (Vec) with path, method, handler for each usage
- Cross-references with route_dependencies for accuracy
- At least 2 unit tests
</acceptance>
</task>

### Task 3: Implement dependency_graph Tool

<task id="3">
<title>Implement dependency_graph tool</title>
<description>
Create a comprehensive dependency graph tool that combines:
- Route-to-model relationships (from route_dependencies)
- Model-to-model relationships (from relation_map)
- Route-to-component relationships (Inertia)

Output format: nodes + edges suitable for visualization.
</description>
<depends_on>1,2</depends_on>
<files>
  <create>cancer-mcp/src/tools/dependency_graph.rs</create>
  <modify>cancer-mcp/src/tools/mod.rs</modify>
  <modify>cancer-mcp/src/service.rs</modify>
</files>
<verification>
  <check>cargo build -p cancer-mcp</check>
  <check>cargo test -p cancer-mcp dependency_graph</check>
  <check>cargo clippy -p cancer-mcp -- -D warnings</check>
</verification>
<acceptance>
- Returns: nodes (Vec with id, type, label), edges (Vec with from, to, relationship)
- Node types: route, model, component
- Edge types: uses_model, belongs_to, renders
- Summary stats: total_routes, total_models, total_relationships
</acceptance>
</task>

### Task 4: Update Tool Descriptions and Documentation

<task id="4">
<title>Update tool descriptions and add workflow documentation</title>
<description>
Enhance service.rs with:
- Structured descriptions for new tools (When/Returns/Combine format)
- Add relationship tools to tool categories
- Update CANCER_MCP_INSTRUCTIONS with relationship analysis workflow
- Cross-link existing tools (relation_map, explain_model) with new tools
</description>
<depends_on>3</depends_on>
<files>
  <modify>cancer-mcp/src/service.rs</modify>
</files>
<verification>
  <check>cargo build -p cancer-mcp</check>
  <check>cargo clippy -p cancer-mcp -- -D warnings</check>
</verification>
<acceptance>
- All 3 new tools have structured descriptions
- CANCER_MCP_INSTRUCTIONS includes "Understanding Relationships" workflow
- Tool categories updated with Relationship Analysis section
</acceptance>
</task>

---

## Execution

### Wave 1 (Parallel: None)
- Task 1: route_dependencies (foundation tool)

### Wave 2 (Parallel: None)
- Task 2: model_usages (depends on Task 1)

### Wave 3 (Parallel: None)
- Task 3: dependency_graph (depends on Tasks 1, 2)

### Wave 4 (Parallel: None)
- Task 4: Documentation (depends on Task 3)

---

## Checkpoints

After Task 1: `cargo test -p cancer-mcp && cargo clippy -p cancer-mcp`
After Task 3: `cargo test -p cancer-mcp && cargo clippy -p cancer-mcp`
Final: `cargo test --workspace && cargo clippy --workspace`

---

## Success Criteria

1. All 3 new tools registered and functional
2. `route_dependencies /users` returns models used by that route
3. `model_usages User` returns all routes that use the User model
4. `dependency_graph` returns complete node/edge representation
5. All tests pass, no clippy warnings
6. Tool descriptions follow established When/Returns/Combine format
