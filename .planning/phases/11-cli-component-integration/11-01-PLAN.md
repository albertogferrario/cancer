---
phase: 11-cli-component-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cancer-cli/src/analyzer.rs
  - cancer-cli/src/commands/make_scaffold.rs
  - cancer-cli/src/templates/mod.rs
autonomous: true
---

<objective>
Enable FK relationship detection and integrate test generation with factory generation.

Purpose: Establish the foundation for component integration by detecting FK patterns in scaffold fields and enabling tests to use generated factories.
Output: Enhanced analyzer with FK detection capability; tests that instantiate models using factories when both `--with-tests` and `--with-factory` flags are used.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-cli-smart-defaults/10-01-SUMMARY.md

@cancer-cli/src/analyzer.rs
@cancer-cli/src/commands/make_scaffold.rs
@cancer-cli/src/templates/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance analyzer with FK relationship detection</name>
  <files>cancer-cli/src/analyzer.rs</files>
  <action>
Add FK detection capability to ProjectAnalyzer:

1. Add `ForeignKeyInfo` struct:
   ```rust
   pub struct ForeignKeyInfo {
       pub field_name: String,      // e.g., "user_id"
       pub target_model: String,    // e.g., "User"
       pub target_table: String,    // e.g., "users"
   }
   ```

2. Add method `detect_foreign_keys(&self, fields: &[(String, FieldType)]) -> Vec<ForeignKeyInfo>`:
   - For each field ending in `_id`, extract the prefix (e.g., `user_id` → `user`)
   - Convert to PascalCase for model name (e.g., `user` → `User`)
   - Convert to snake_case plural for table name (e.g., `user` → `users`)
   - Check if target model exists in `self.list_models()` - if it does, mark as `validated: true`
   - Return list of detected FKs

3. Add method `model_exists(&self, name: &str) -> bool`:
   - Case-insensitive check against known models
   - Used for FK validation

Use existing `infer_field_type()` pattern from make_scaffold.rs as reference for field naming detection.
  </action>
  <verify>cargo test -p cancer-cli -- --test-threads=1 passes; cargo clippy -p cancer-cli passes</verify>
  <done>ProjectAnalyzer can detect FK fields and map them to target models; validation against existing models works</done>
</task>

<task type="auto">
  <name>Task 2: Integrate test generation with factory usage</name>
  <files>cancer-cli/src/templates/mod.rs, cancer-cli/src/commands/make_scaffold.rs</files>
  <action>
When both `--with-tests` and `--with-factory` are passed, generate tests that use the factory:

1. In `templates/mod.rs`, create `scaffold_test_with_factory_template(name: &str, fields: &[...]) -> String`:
   - Import the factory module: `use crate::factories::{snake_name}_factory::*;`
   - In test setup, create model instances using factory:
     ```rust
     let model = {PascalName}Factory::new().create(&db).await;
     ```
   - For index test: create 3 models with factory
   - For show test: create 1 model, use its ID
   - For store test: use factory to generate valid input data
   - For update test: create model with factory, then update
   - For destroy test: create model with factory, then delete

2. In `make_scaffold.rs`, modify test generation logic:
   - Check if both `with_tests` and `with_factory` flags are set
   - If yes, use `scaffold_test_with_factory_template`
   - If only `with_tests`, use existing `scaffold_test_template` (placeholder stubs)

3. Update the test template to include necessary imports:
   - `use crate::factories::{snake_name}_factory::{PascalName}Factory;`
   - `use cancer::testing::TestDatabase;` (for DB setup in tests)

Keep existing test stub behavior when `--with-factory` is not used.
  </action>
  <verify>cargo build -p cancer-cli succeeds; generate scaffold with both flags and inspect test output</verify>
  <done>Tests generated with `--with-tests --with-factory` use factory for model creation; tests with only `--with-tests` remain as placeholder stubs</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for FK detection</name>
  <files>cancer-cli/src/analyzer.rs</files>
  <action>
Add unit tests for the new FK detection functionality:

1. `test_detect_foreign_keys_basic`:
   - Input: fields with `user_id`, `category_id`, `title`
   - Assert: detects 2 FKs (user_id → User, category_id → Category)
   - Assert: title is NOT detected as FK

2. `test_detect_foreign_keys_with_model_validation`:
   - Setup: tempdir with `src/models/user.rs` (User model exists)
   - Input: fields with `user_id`, `category_id`
   - Assert: user_id FK has `validated: true` (model exists)
   - Assert: category_id FK has `validated: false` (model doesn't exist)

3. `test_model_exists`:
   - Setup: tempdir with `src/models/user.rs`, `src/models/post.rs`
   - Assert: `model_exists("User")` returns true
   - Assert: `model_exists("user")` returns true (case insensitive)
   - Assert: `model_exists("Comment")` returns false

Use tempfile crate pattern from existing analyzer tests.
  </action>
  <verify>cargo test -p cancer-cli -- --test-threads=1 passes</verify>
  <done>All new FK detection tests pass; no regressions in existing tests</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo test -p cancer-cli -- --test-threads=1` passes (all tests including new ones)
- [ ] `cargo clippy -p cancer-cli` passes with no warnings
- [ ] `cargo build -p cancer-cli` succeeds
- [ ] Manual test: `cargo run -p cancer-cli -- make:scaffold Post title:string user_id --with-tests --with-factory -y` generates test file with factory imports
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- FK detection works for `*_id` field patterns
- Model existence validation works
- Tests integrate with factories when both flags are used
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/11-cli-component-integration/11-01-SUMMARY.md`
</output>
