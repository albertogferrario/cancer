---
phase: 22.6-contract-validation-cli
plan: 01
status: planned
---

<objective>
Expose the existing MCP validate_contracts tool as a CLI command for CI integration, with enhanced structural nesting validation.

Issues addressed:
- #4 No Props Contract Validation CLI (Medium) - MCP tool exists but needs CLI exposure
- #9 Nested vs Flat Props Structure Mismatch (High) - Add structural validation
</objective>

<execution_context>
@.planning/PROJECT.md
@.planning/phases/22.4-type-generator-fixes/22.4-01-SUMMARY.md
@.planning/phases/22.5-prop-naming-collisions/22.5-01-SUMMARY.md
</execution_context>

<context>
**Current State:**

The MCP tool `ferro-mcp/src/tools/validate_contracts.rs` (663 lines) already implements:
- Route parsing from routes.rs
- Handler → component mapping via `inertia_response!` calls
- Rust props extraction from handler files
- TypeScript props extraction from component files
- Field comparison with mismatch types: MissingInBackend, MissingInFrontend, TypeMismatch, NullabilityMismatch

**Gap #1 - No CLI Command:**
There's no `ferro validate-contracts` command. Users must use the MCP tool through an AI assistant.

**Gap #2 - No Structural Validation:**
The current tool compares flat field names but doesn't validate nesting structure. Example mismatch:
```rust
// Backend sends flat:
pub struct ShowProps {
    pub application: ApplicationDetail,
    pub animal: Animal,  // Separate top-level
}
```
```typescript
// Frontend expects nested:
interface ShowProps {
  application: {
    animal: Animal;  // Nested inside application
  };
}
```
This causes silent runtime failures (`application.animal` is undefined).

**Solution approach:**
1. Extract shared validation logic to a library crate or shared module
2. Create `ferro validate-contracts` CLI command
3. Add structural nesting comparison (recursively compare nested object shapes)
4. Provide CI-friendly output (exit code 1 on failures, summary output)
</context>

<tasks>

<task id="1" effort="M">
<title>Create validate_contracts CLI command</title>
<files>
- ferro-cli/src/commands/validate_contracts.rs (new)
- ferro-cli/src/commands/mod.rs
- ferro-cli/src/main.rs
</files>
<description>
Create the CLI command by reusing MCP validation logic.

1. Create `ferro-cli/src/commands/validate_contracts.rs` that:
   - Copies/adapts the core logic from `ferro-mcp/src/tools/validate_contracts.rs`
   - Uses the project root (current directory) as the validation target
   - Formats output for terminal (colored pass/fail, summary)

2. Add CLI command to main.rs:
   ```rust
   /// Validate backend/frontend prop contracts
   #[command(name = "validate-contracts")]
   ValidateContracts {
       /// Filter by route or component name
       #[arg(long, short = 'f')]
       filter: Option<String>,

       /// Output format: human (default), json
       #[arg(long, default_value = "human")]
       format: String,

       /// Strict mode: fail on any mismatch (including unused backend fields)
       #[arg(long)]
       strict: bool,
   },
   ```

3. Exit codes: 0 = all passed, 1 = failures found, 2 = error running validation

4. Human-readable output format:
   ```
   ✓ /users (User/Index)
   ✗ /animals/{id} (Animal/Show)
     - MissingInBackend: animal.shelter (frontend expects nested)
     - TypeMismatch: created_at (backend: String, frontend: Date)

   Validation: 5 passed, 1 failed, 2 skipped
   ```
</description>
</task>

<task id="2" effort="L" depends="1">
<title>Add structural nesting validation</title>
<files>
- ferro-cli/src/commands/validate_contracts.rs
</files>
<description>
Enhance comparison to detect nested vs flat structure mismatches.

1. Add `StructureMismatch` to MismatchKind enum:
   ```rust
   pub enum MismatchKind {
       MissingInBackend,
       MissingInFrontend,
       TypeMismatch,
       NullabilityMismatch,
       StructureMismatch,  // New
   }
   ```

2. Parse nested structure in TypeScript interfaces:
   - Detect `field: { nested_field: Type }` patterns
   - Build a tree structure representing nested props

3. Parse nested structure in Rust props:
   - When a field type is another struct, resolve it
   - Build matching tree structure

4. Add `compare_structure()` function:
   - Recursively compare prop trees
   - Report when frontend expects nesting but backend is flat
   - Report when nesting depth differs

5. Example detection:
   ```
   StructureMismatch: 'animal' - frontend expects nested inside 'application'
   but backend sends as separate top-level prop
   ```
</description>
</task>

<task id="3" effort="S" depends="1">
<title>Add JSON output format</title>
<files>
- ferro-cli/src/commands/validate_contracts.rs
</files>
<description>
Add JSON output for CI/CD tooling integration.

1. When `--format json`, output the ContractValidationResult as JSON
2. Ensure all fields are serializable (already using serde)
3. Add timestamp and version fields for CI tracking:
   ```json
   {
     "timestamp": "2026-01-17T12:00:00Z",
     "ferro_version": "2.0.2",
     "total_routes": 15,
     "passed": 12,
     "failed": 2,
     "skipped": 1,
     "validations": [...]
   }
   ```
</description>
</task>

<task id="4" effort="S" depends="1,2">
<title>Add comprehensive tests</title>
<files>
- ferro-cli/src/commands/validate_contracts.rs
</files>
<description>
Add unit tests for validation logic.

1. Test parse_routes_with_components with various route patterns
2. Test Rust props extraction from handler files
3. Test TypeScript props extraction from component files
4. Test field comparison logic
5. Test structural nesting detection:
   - Flat backend vs nested frontend (should fail)
   - Matching nested structures (should pass)
   - Extra nesting in backend (should detect)
6. Test output formatting (human and JSON)
7. Test exit codes
</description>
</task>

<task id="5" effort="S" depends="1">
<title>Sync MCP tool with CLI enhancements</title>
<files>
- ferro-mcp/src/tools/validate_contracts.rs
</files>
<description>
Backport structural validation to MCP tool.

1. Add StructureMismatch to MCP's MismatchKind enum
2. Add nested structure parsing (from Task 2)
3. Add compare_structure() function
4. Ensure MCP and CLI produce identical results
</description>
</task>

</tasks>

<verification>
```bash
# Build
cargo build --all

# Tests
cargo test -p ferro-cli -p ferro-mcp

# Lint
cargo clippy --all -- -D warnings

# Format
cargo fmt --check

# Manual test (in a ferro project)
cd /path/to/ferro/project
ferro validate-contracts
ferro validate-contracts --format json
ferro validate-contracts --filter "/users"
ferro validate-contracts --strict
```
</verification>

<success_criteria>
- [ ] `ferro validate-contracts` command works
- [ ] Structural nesting mismatches detected
- [ ] Human-readable output with colored pass/fail
- [ ] JSON output format works
- [ ] Exit code 1 on failures (for CI)
- [ ] MCP tool synced with CLI enhancements
- [ ] All tests pass
- [ ] No clippy warnings
</success_criteria>

<output>
Commits (atomic, one per task):
1. `feat(cli): add validate-contracts command`
2. `feat(validate-contracts): add structural nesting validation`
3. `feat(validate-contracts): add JSON output format`
4. `test(validate-contracts): add comprehensive tests`
5. `feat(ferro-mcp): sync structural validation from CLI`

Update .planning/STATE.md with phase completion.
Create SUMMARY.md documenting changes and decisions.
</output>
