---
phase: 09-cli-feature-scaffolding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cancer-cli/src/commands/make_scaffold.rs
  - cancer-cli/src/templates/mod.rs
  - cancer-cli/src/main.rs
autonomous: true
---

<objective>
Enhance `make:scaffold` command with test generation, factory integration, route auto-registration, and API-only mode.

Purpose: Enable agents and developers to scaffold complete, production-ready features with a single command - including tests, factories, and proper route integration.
Output: Enhanced scaffold command with `--with-tests`, `--with-factory`, `--auto-routes`, and `--api` flags.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-cli-feature-scaffolding/09-RESEARCH.md

# Prior phase - generation hints context (tools for agent code generation)
@.planning/phases/08-mcp-generation-hints/08-01-SUMMARY.md

# Source files
@cancer-cli/src/commands/make_scaffold.rs
@cancer-cli/src/commands/make_factory.rs
@cancer-cli/src/templates/mod.rs
@cancer-cli/src/main.rs
@framework/src/testing/mod.rs
@framework/src/testing/http.rs
@app/src/routes.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --with-tests flag to scaffold</name>
  <files>cancer-cli/src/commands/make_scaffold.rs, cancer-cli/src/templates/mod.rs, cancer-cli/src/main.rs</files>
  <action>
1. Update `main.rs` MakeScaffold command to add `--with-tests` flag (bool, default false)
2. Update `make_scaffold.rs` run function signature to accept `with_tests: bool` parameter
3. Add `generate_tests()` function that creates controller test file using cancer::testing patterns:
   - Create `src/tests/{snake_name}_controller_test.rs` with CRUD test stubs
   - Use TestClient for HTTP assertions
   - Include test cases: test_{plural}_index (GET list), test_{plural}_show (GET single), test_{plural}_store (POST create), test_{plural}_update (PUT), test_{plural}_destroy (DELETE)
   - Each test uses assert_status(), assert_json_path() patterns
4. Add `scaffold_test_template()` function to templates/mod.rs that generates test file content
5. Create/update `src/tests/mod.rs` to include the new test module

Test template should follow existing cancer::testing patterns from http.rs - use TestClient::new(), get/post/put/delete builders, assert_status/assert_ok assertions.

Do NOT use expect! macro (it's complex). Use standard assert!() with TestResponse methods.
  </action>
  <verify>cargo build -p cancer-cli && cargo test -p cancer-cli</verify>
  <done>--with-tests flag works, generates compilable test file with 5 CRUD test stubs</done>
</task>

<task type="auto">
  <name>Task 2: Add --with-factory flag to scaffold</name>
  <files>cancer-cli/src/commands/make_scaffold.rs, cancer-cli/src/templates/mod.rs, cancer-cli/src/main.rs</files>
  <action>
1. Update `main.rs` MakeScaffold command to add `--with-factory` flag (bool, default false)
2. Update `make_scaffold.rs` run function signature to accept `with_factory: bool` parameter
3. Add `generate_scaffold_factory()` function that:
   - Reuses existing `make_factory` logic but with field pre-population
   - Passes parsed fields from scaffold definition to generate factory with matching field types
   - Factory uses Fake trait for field generation (Fake::email(), Fake::word(), etc.)
4. Add `scaffold_factory_template()` to templates/mod.rs that:
   - Takes field definitions as input
   - Generates Factory impl with Fake values based on field types:
     - String/Text → Fake::sentence()
     - Integer → rand::thread_rng().gen_range(1..1000)
     - Boolean → rand::thread_rng().gen_bool(0.5)
     - DateTime → chrono::Utc::now()
     - etc.
5. Create/update `src/factories/mod.rs` to include new factory module

The factory should implement `Factory` trait from cancer::testing::Factory.
  </action>
  <verify>cargo build -p cancer-cli && cargo test -p cancer-cli</verify>
  <done>--with-factory flag works, generates factory with field types matching scaffold definition</done>
</task>

<task type="auto">
  <name>Task 3: Add --auto-routes flag with confirmation</name>
  <files>cancer-cli/src/commands/make_scaffold.rs, cancer-cli/src/main.rs</files>
  <action>
1. Update `main.rs` MakeScaffold command to add `--auto-routes` flag (bool, default false)
2. Update `make_scaffold.rs` run function signature to accept `auto_routes: bool` parameter
3. Add `register_routes()` function that:
   - Reads src/routes.rs content
   - Finds appropriate insertion point (before final closing brace of routes! macro)
   - Constructs route entry: `resource!("/{plural}", controllers::{snake}_controller),`
   - Also adds use statement: `use crate::controllers::{snake}_controller;` if not present
   - Uses dialoguer::Confirm to ask user before modifying (unless --yes flag)
4. Add `--yes` flag to skip confirmation prompt (for CI/automation)
5. Replace `print_route_instructions()` call with conditional:
   - If auto_routes: call register_routes()
   - Else: call print_route_instructions() as before

Route insertion should use regex or string matching to find `routes! {` and insert before its closing `}`. Do NOT parse Rust AST - simple string manipulation is sufficient.

Use dialoguer crate for confirmation (already in cancer-cli dependencies via clap).
  </action>
  <verify>cargo build -p cancer-cli && cargo test -p cancer-cli</verify>
  <done>--auto-routes flag prompts for confirmation and modifies routes.rs correctly. --yes skips prompt.</done>
</task>

<task type="auto">
  <name>Task 4: Add --api flag for API-only scaffold</name>
  <files>cancer-cli/src/commands/make_scaffold.rs, cancer-cli/src/templates/mod.rs, cancer-cli/src/main.rs</files>
  <action>
1. Update `main.rs` MakeScaffold command to add `--api` flag (bool, default false)
2. Update `make_scaffold.rs` run function signature to accept `api_only: bool` parameter
3. Modify `generate_controller()` to check api_only flag:
   - If api_only: use `api_controller_template()` (JSON responses, no Inertia)
   - Else: use existing controller template
4. Add `api_controller_template()` to templates/mod.rs that:
   - Returns JSON responses using json_response! macro
   - No Inertia::render calls
   - Same CRUD structure but pure JSON API
5. Modify `generate_inertia_pages()` call to be conditional:
   - Skip if api_only flag is true
6. Update success message to indicate API-only mode when active

API controller should use `json_response!` macro pattern from existing controllers. Response format:
- index: `{"data": [...], "meta": {"total": n}}`
- show: `{"data": {...}}`
- store/update: `{"data": {...}, "message": "Created/Updated successfully"}`
- destroy: `{"message": "Deleted successfully"}`
  </action>
  <verify>cargo build -p cancer-cli && cargo test -p cancer-cli</verify>
  <done>--api flag skips Inertia pages and generates JSON-only controller</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo build -p cancer-cli` succeeds
- [ ] `cargo test -p cancer-cli` passes all tests
- [ ] `cargo clippy -p cancer-cli` has no new warnings
- [ ] New flags appear in `cancer make:scaffold --help`
- [ ] Manual test: `cancer make:scaffold TestResource title:string --with-tests --with-factory --api` generates expected files
</verification>

<success_criteria>
- All 4 flags implemented and documented in CLI help
- Test generation creates compilable test file with CRUD stubs
- Factory generation pre-populates fields from scaffold definition
- Route auto-registration works with confirmation prompt
- API-only mode skips Inertia pages and uses JSON responses
- All existing scaffold functionality preserved
- No regressions in cancer-cli tests
</success_criteria>

<output>
After completion, create `.planning/phases/09-cli-feature-scaffolding/09-01-SUMMARY.md`
</output>
