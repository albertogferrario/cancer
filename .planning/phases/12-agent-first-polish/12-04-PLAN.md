---
phase: 12-agent-first-polish
plan: 04
type: execute
wave: 1
depends_on: []
files_modified: [cancer-cli/src/commands/mod.rs, cancer-cli/src/commands/clean.rs, cancer-cli/src/commands/serve.rs]
autonomous: true
---

<objective>
Integrate cargo-sweep for automatic build artifact cleanup to prevent disk saturation during development.

Purpose: Cancer projects can consume 10-20GB of disk space from build artifacts. Best DX means developers never think about cleanup - it happens automatically. The framework should be self-maintaining.

Output: Automatic cleanup on `cancer serve` startup + explicit `cancer clean` command for manual control.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@cancer-cli/src/commands/mod.rs
@cancer-cli/src/commands/serve.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add clean command module</name>
  <files>cancer-cli/src/commands/clean.rs, cancer-cli/src/commands/mod.rs</files>
  <action>
Create `cancer-cli/src/commands/clean.rs`:

```rust
use clap::Args;
use std::process::Command;

#[derive(Args)]
pub struct CleanArgs {
    /// Remove artifacts older than N days (default: 30)
    #[arg(short, long, default_value = "30")]
    days: u32,

    /// Also remove artifacts from old toolchains
    #[arg(short, long)]
    toolchains: bool,

    /// Skip cargo-sweep installation check
    #[arg(long)]
    skip_install_check: bool,
}

pub fn run(args: CleanArgs) -> anyhow::Result<()> {
    // Check if cargo-sweep is installed
    if !args.skip_install_check && !is_sweep_installed() {
        println!("cargo-sweep not found. Install it for automatic cleanup:");
        println!("  cargo install cargo-sweep");
        println!();
        println!("Or run with --skip-install-check to skip this message.");
        return Ok(());
    }

    println!("Cleaning build artifacts older than {} days...", args.days);

    // Run cargo sweep --time N
    let output = Command::new("cargo")
        .args(["sweep", "--time", &args.days.to_string()])
        .output()?;

    if output.status.success() {
        let stdout = String::from_utf8_lossy(&output.stdout);
        // Parse output to show cleaned size
        if let Some(cleaned) = parse_sweep_output(&stdout) {
            println!("Cleaned {}", cleaned);
        } else {
            println!("Cleanup complete.");
        }
    } else {
        let stderr = String::from_utf8_lossy(&output.stderr);
        eprintln!("Sweep failed: {}", stderr);
    }

    // Optionally clean old toolchains
    if args.toolchains {
        println!("Cleaning artifacts from old toolchains...");
        let output = Command::new("cargo")
            .args(["sweep", "--installed"])
            .output()?;

        if output.status.success() {
            println!("Toolchain cleanup complete.");
        }
    }

    Ok(())
}

/// Run sweep silently, return cleaned size if any
pub fn run_silent(days: u32) -> Option<String> {
    if !is_sweep_installed() {
        return None;
    }

    let output = Command::new("cargo")
        .args(["sweep", "--time", &days.to_string()])
        .output()
        .ok()?;

    if output.status.success() {
        let stdout = String::from_utf8_lossy(&output.stdout);
        parse_sweep_output(&stdout)
    } else {
        None
    }
}

fn is_sweep_installed() -> bool {
    Command::new("cargo")
        .args(["sweep", "--version"])
        .output()
        .map(|o| o.status.success())
        .unwrap_or(false)
}

fn parse_sweep_output(output: &str) -> Option<String> {
    // cargo-sweep outputs lines like "Cleaned 16.6GiB total"
    for line in output.lines() {
        if line.contains("Cleaned") && (line.contains("GiB") || line.contains("MiB") || line.contains("KiB")) {
            // Extract the size portion
            if let Some(start) = line.find("Cleaned") {
                let size_part = &line[start..];
                return Some(size_part.to_string());
            }
        }
    }
    None
}
```

Update `cancer-cli/src/commands/mod.rs` to include the new module and command:
- Add `pub mod clean;`
- Add `Clean(clean::CleanArgs)` variant to Commands enum
- Add match arm: `Commands::Clean(args) => clean::run(args)`
  </action>
  <verify>cargo build --package cancer-cli passes</verify>
  <done>cancer clean command exists with --days and --toolchains flags</done>
</task>

<task type="auto">
  <name>Task 2: Integrate automatic sweep into serve command</name>
  <files>cancer-cli/src/commands/serve.rs</files>
  <action>
Add automatic sweep on `cancer serve` startup:

1. At the start of the serve command (before starting servers), add:

```rust
use super::clean;

// Near the start of run(), after parsing args:
// Auto-cleanup old artifacts (silent, non-blocking)
if let Some(cleaned) = clean::run_silent(7) {
    println!("{} {}", console::style("♻").cyan(), cleaned);
}
```

2. The sweep runs with 7-day threshold (more aggressive for dev workflow)
3. Only shows output if something was cleaned
4. Uses emoji for visual distinction from other startup messages
5. Non-blocking - if sweep fails or isn't installed, serve continues normally

Place this BEFORE the "Starting development servers..." message so cleanup happens first.
  </action>
  <verify>cargo build --package cancer-cli passes</verify>
  <done>cancer serve automatically cleans artifacts older than 7 days on startup</done>
</task>

<task type="auto">
  <name>Task 3: Add configuration via environment variable</name>
  <files>cancer-cli/src/commands/serve.rs, cancer-cli/src/commands/clean.rs</files>
  <action>
Make the auto-sweep configurable:

1. In serve.rs, read from environment:
```rust
let sweep_days: u32 = std::env::var("CARGO_SWEEP_DAYS")
    .ok()
    .and_then(|v| v.parse().ok())
    .unwrap_or(7);

// Set to 0 to disable
if sweep_days > 0 {
    if let Some(cleaned) = clean::run_silent(sweep_days) {
        println!("{} {}", console::style("♻").cyan(), cleaned);
    }
}
```

2. Add to .env.example (if Plan 12-02 is complete) or note for documentation:
```
# Auto-cleanup build artifacts older than N days on `cancer serve`
# Set to 0 to disable automatic cleanup
CARGO_SWEEP_DAYS=7
```

This allows developers to:
- Disable auto-sweep: `CARGO_SWEEP_DAYS=0`
- Be more aggressive: `CARGO_SWEEP_DAYS=3`
- Be less aggressive: `CARGO_SWEEP_DAYS=14`
  </action>
  <verify>cargo build --package cancer-cli passes</verify>
  <done>Auto-sweep threshold configurable via CARGO_SWEEP_DAYS environment variable</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo build --package cancer-cli` succeeds
- [ ] `cancer clean --help` shows days and toolchains options
- [ ] `cancer clean` runs cargo-sweep or shows install instructions
- [ ] `cancer serve` shows cleanup message when artifacts are cleaned
- [ ] `CARGO_SWEEP_DAYS=0` disables auto-sweep
- [ ] Missing cargo-sweep doesn't break serve command
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Developers never manually manage disk space from Cancer builds
- Auto-cleanup is transparent and non-intrusive
- Manual `cancer clean` available for explicit control
</success_criteria>

<output>
After completion, create `.planning/phases/12-agent-first-polish/12-04-SUMMARY.md`
</output>
