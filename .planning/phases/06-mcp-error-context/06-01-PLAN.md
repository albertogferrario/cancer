---
phase: 06-mcp-error-context
plan: 01
wave: 1
depends_on: []
files_modified:
  - cancer-mcp/src/tools/last_error.rs
  - cancer-mcp/src/tools/diagnose_error.rs
  - cancer-mcp/src/tools/mod.rs
  - cancer-mcp/src/service.rs
  - cancer-mcp/src/error.rs
autonomous: true
---

# Phase 6 Plan 1: MCP Error Context Enhancement

**Enhance cancer-mcp error tools with richer diagnostic information and actionable fix suggestions**

## Context

Phase 5 established semantic understanding tools (explain_route, explain_model, domain_glossary). Phase 6 builds on this foundation to provide better error diagnostics for agents.

Current gaps:
- `last_error` only parses log files, missing correlation to routes/handlers
- No actionable fix suggestions based on error patterns
- Framework has rich FrameworkError types but MCP doesn't expose their structure
- No error categorization or common fix patterns

## Discovery

Level: 0-1 (existing error patterns, unlikely research needed)

**Key files analyzed:**
- `cancer-mcp/src/tools/last_error.rs` - Current log-based error parsing
- `framework/src/error.rs` - Rich FrameworkError enum with structured variants
- `cancer-mcp/src/service.rs` - Tool descriptions and registration

**Patterns to leverage:**
- FrameworkError variants have structured data (field names, type names, status codes)
- Phase 5's explain tools can provide semantic context for errors
- Structured tool description format from Phase 5 (When/Returns/Combine)

## Tasks

### Task 1: Enhance last_error with route correlation
**Wave 1** | Autonomous: Yes

Enhance the existing `last_error` tool to correlate errors with routes and provide richer context.

#### Inputs
- Current last_error.rs implementation
- Route introspection from list_routes tool

#### Outputs
- Enhanced ErrorDetails struct with route/handler correlation
- Error category classification
- Related routes identification

#### Specification

```xml
<task id="1" title="Enhance last_error with route correlation">
  <context>
    The current last_error tool only parses log files for ERROR/PANIC patterns.
    It returns basic info (timestamp, level, message, stacktrace) but lacks
    correlation to application routes and handlers.
  </context>

  <requirements>
    <functional>
      <requirement id="F1">Add route_context field to ErrorDetails: handler name, route path, HTTP method</requirement>
      <requirement id="F2">Add error_category enum: Validation, Database, NotFound, Permission, Internal, Panic</requirement>
      <requirement id="F3">Extract route info from error message patterns (e.g., "at /users/123" or "handler: show_user")</requirement>
      <requirement id="F4">Include related_routes: list of routes that might be affected by similar errors</requirement>
    </functional>
    <non-functional>
      <requirement id="NF1">Maintain backward compatibility - existing fields unchanged</requirement>
      <requirement id="NF2">Pattern matching should be fast (regex compilation cached)</requirement>
    </non-functional>
  </requirements>

  <implementation>
    <step order="1">Add new fields to ErrorDetails struct:
      - route_context: Option&lt;RouteContext&gt; with handler, path, method
      - error_category: ErrorCategory enum
      - related_routes: Vec&lt;String&gt;</step>
    <step order="2">Create ErrorCategory enum with variants: Validation, Database, NotFound, Permission, Internal, Panic</step>
    <step order="3">Add categorize_error function that analyzes message content:
      - "validation" / "invalid" → Validation
      - "not found" / "404" → NotFound
      - "database" / "sql" / "query" → Database
      - "permission" / "forbidden" / "401" / "403" → Permission
      - "panic" / "fatal" → Panic
      - fallback → Internal</step>
    <step order="4">Add extract_route_context function using regex patterns:
      - "/path/to/resource" patterns
      - "handler: handler_name" patterns
      - "at controller::action" patterns</step>
    <step order="5">Update execute function to call categorize_error and extract_route_context</step>
  </implementation>

  <verification>
    <check type="build">cargo build -p cancer-mcp</check>
    <check type="lint">cargo clippy -p cancer-mcp</check>
    <check type="test">cargo test -p cancer-mcp</check>
  </verification>

  <commit>
    <type>feat</type>
    <scope>cancer-mcp</scope>
    <description>enhance last_error with route correlation and categorization</description>
  </commit>
</task>
```

---

### Task 2: Create diagnose_error tool with fix suggestions
**Wave 2** | Autonomous: Yes | Depends: Task 1

Create a new `diagnose_error` tool that analyzes errors and suggests fixes based on error patterns.

#### Inputs
- Error message or category from last_error
- Application context (routes, models)

#### Outputs
- Structured diagnosis with cause analysis
- Actionable fix suggestions
- Related documentation/examples

#### Specification

```xml
<task id="2" title="Create diagnose_error tool with fix suggestions">
  <context>
    Agents need actionable guidance when errors occur. A diagnose_error tool
    should analyze error patterns and suggest concrete fixes based on the
    framework's conventions and common error causes.
  </context>

  <requirements>
    <functional>
      <requirement id="F1">Accept error message or ErrorCategory as input</requirement>
      <requirement id="F2">Return structured diagnosis: likely_cause, fix_suggestions, related_tools</requirement>
      <requirement id="F3">Provide category-specific fix patterns:
        - Validation: Check field rules, review validation macro usage
        - NotFound: Verify route exists, check model ID, review URL pattern
        - Database: Check migration status, verify connection, review query
        - Permission: Check middleware, verify auth setup
        - Panic: Check for unwrap(), review error handling
      </requirement>
      <requirement id="F4">Include code_examples where applicable</requirement>
      <requirement id="F5">Suggest follow-up tools to investigate further</requirement>
    </functional>
    <non-functional>
      <requirement id="NF1">Suggestions should be specific to Cancer framework patterns</requirement>
      <requirement id="NF2">Each fix suggestion should be actionable (do X, not "might need to...")</requirement>
    </non-functional>
  </requirements>

  <implementation>
    <step order="1">Create cancer-mcp/src/tools/diagnose_error.rs</step>
    <step order="2">Define DiagnoseErrorParams: error_message: Option&lt;String&gt;, category: Option&lt;ErrorCategory&gt;</step>
    <step order="3">Define ErrorDiagnosis struct:
      - category: ErrorCategory
      - likely_cause: String
      - fix_suggestions: Vec&lt;FixSuggestion&gt;
      - code_example: Option&lt;String&gt;
      - related_tools: Vec&lt;String&gt;</step>
    <step order="4">Define FixSuggestion struct: action: String, details: String, priority: u8</step>
    <step order="5">Implement diagnosis logic per category with Cancer-specific fixes:
      - Validation: "Add #[rule(required())] to field", "Check ValidateRules derive"
      - NotFound: "Verify route in list_routes output", "Check model exists in database"
      - Database: "Run pending migrations", "Check DATABASE_URL in .env"
      - Permission: "Add auth middleware to route group", "Check user permissions"
      - Panic: "Replace .unwrap() with .ok_or()?", "Add error handling"</step>
    <step order="6">Export from tools/mod.rs</step>
    <step order="7">Register tool in service.rs with structured description</step>
  </implementation>

  <verification>
    <check type="build">cargo build -p cancer-mcp</check>
    <check type="lint">cargo clippy -p cancer-mcp</check>
    <check type="test">cargo test -p cancer-mcp</check>
  </verification>

  <commit>
    <type>feat</type>
    <scope>cancer-mcp</scope>
    <description>add diagnose_error tool with fix suggestions</description>
  </commit>
</task>
```

---

### Task 3: Add error_patterns resource for common issues
**Wave 2** | Autonomous: Yes | Depends: Task 1

Create a resource that documents common error patterns and their resolutions, similar to domain_glossary.

#### Inputs
- Common Cancer framework error patterns
- Fix patterns from diagnose_error

#### Outputs
- Structured error pattern catalog
- Searchable by error message fragments

#### Specification

```xml
<task id="3" title="Add error_patterns resource">
  <context>
    Agents benefit from a catalog of known error patterns they can reference.
    This complements diagnose_error by providing a browsable/searchable
    reference of common issues.
  </context>

  <requirements>
    <functional>
      <requirement id="F1">Return list of common error patterns with:
        - pattern: regex or string to match
        - category: ErrorCategory
        - description: what causes this error
        - resolution: how to fix it
        - example: sample error message</requirement>
      <requirement id="F2">Cover key error types:
        - Validation errors (field, format, required)
        - Database errors (connection, migration, query)
        - Route errors (404, method not allowed)
        - Auth errors (401, 403)
        - Framework errors (service not found, param error)</requirement>
      <requirement id="F3">Include framework-specific patterns:
        - "ServiceNotFound: {type_name}" → Missing #[injectable]
        - "ValidationError: {field}" → Check validation rules
        - "ModelNotFound: {model}" → Record doesn't exist</requirement>
    </functional>
  </requirements>

  <implementation>
    <step order="1">Create cancer-mcp/src/resources/error_patterns.rs</step>
    <step order="2">Define ErrorPattern struct: pattern, category, description, resolution, example</step>
    <step order="3">Implement get_error_patterns() returning hardcoded catalog of 15-20 common patterns</step>
    <step order="4">Group patterns by category for easy browsing</step>
    <step order="5">Export from resources/mod.rs</step>
    <step order="6">Register as error_patterns tool in service.rs</step>
  </implementation>

  <verification>
    <check type="build">cargo build -p cancer-mcp</check>
    <check type="lint">cargo clippy -p cancer-mcp</check>
    <check type="test">cargo test -p cancer-mcp</check>
  </verification>

  <commit>
    <type>feat</type>
    <scope>cancer-mcp</scope>
    <description>add error_patterns catalog for common issues</description>
  </commit>
</task>
```

---

### Task 4: Enhance tool descriptions with error guidance
**Wave 3** | Autonomous: Yes | Depends: Task 2, Task 3

Update tool descriptions to include error-related guidance, linking to new diagnostic tools.

#### Inputs
- All existing tool descriptions in service.rs
- New error tools from Tasks 1-3

#### Outputs
- Enhanced descriptions mentioning error diagnostics
- Updated error debugging workflow in server instructions

#### Specification

```xml
<task id="4" title="Enhance tool descriptions with error guidance">
  <context>
    Phase 5 established the structured description format (When/Returns/Combine).
    Now we add error-specific guidance to help agents know when to use
    diagnostic tools.
  </context>

  <requirements>
    <functional>
      <requirement id="F1">Update last_error description to mention new capabilities</requirement>
      <requirement id="F2">Add diagnose_error to "Combine with" sections of relevant tools</requirement>
      <requirement id="F3">Update server instructions with enhanced error debugging workflow:
        1. last_error → get categorized error with context
        2. diagnose_error → get fix suggestions
        3. error_patterns → reference common issues
        4. explain_route/explain_model → understand affected code
        5. test_route → verify fix</requirement>
      <requirement id="F4">Add "On error" guidance to tools that commonly fail (test_route, validate_contracts)</requirement>
    </functional>
  </requirements>

  <implementation>
    <step order="1">Update last_error tool description in service.rs:
      - Mention route correlation and categorization
      - Add "Combine with: diagnose_error for fix suggestions"</step>
    <step order="2">Add diagnose_error tool description with structured format</step>
    <step order="3">Add error_patterns tool description</step>
    <step order="4">Update test_route description: "On error: Use last_error then diagnose_error"</step>
    <step order="5">Update validate_contracts description with error guidance</step>
    <step order="6">Update ERROR DEBUGGING workflow in server instructions</step>
  </implementation>

  <verification>
    <check type="build">cargo build -p cancer-mcp</check>
    <check type="lint">cargo clippy -p cancer-mcp</check>
    <check type="test">cargo test -p cancer-mcp</check>
  </verification>

  <commit>
    <type>feat</type>
    <scope>cancer-mcp</scope>
    <description>enhance tool descriptions with error debugging guidance</description>
  </commit>
</task>
```

---

## Dependency Graph

```
Task 1: Enhance last_error (Wave 1)
    │
    ├──→ Task 2: Create diagnose_error (Wave 2)
    │
    └──→ Task 3: Add error_patterns (Wave 2)
              │
              └──→ Task 4: Enhance descriptions (Wave 3)
                          ↑
              Task 2 ─────┘
```

## Wave Assignments

| Wave | Tasks | Can Parallelize |
|------|-------|-----------------|
| 1 | Task 1 | No (single task) |
| 2 | Task 2, Task 3 | Yes |
| 3 | Task 4 | No (depends on 2&3) |

## Checkpoints

- **After Wave 1:** last_error returns enriched error info with categories
- **After Wave 2:** Full diagnostic toolkit (diagnose_error + error_patterns) available
- **After Wave 3:** All tools integrated with consistent error guidance

## Success Criteria

1. `last_error` returns structured error categories and route context
2. `diagnose_error` provides actionable, Cancer-specific fix suggestions
3. `error_patterns` catalogs 15+ common error patterns
4. All tool descriptions guide agents to appropriate diagnostic tools
5. Error debugging workflow documented in server instructions

## Estimated Scope

- **Tasks:** 4
- **Files modified:** ~6
- **Context budget:** Light (existing patterns, no research)
- **Risk:** Low (builds on established MCP patterns)
